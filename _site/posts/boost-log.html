
<!doctype>
<html lang="en">
  <head>
    <meta content='boost::log使用 - cuipf blog' name='title' />
    <meta content='boost::log使用 - cuipf blog' name='og:title' />
    <title>boost::log使用 - cuipf blog</title>
    <link href='http://localhost:3000/images/fav.png' rel='shortcut icon'>
<link href='http://localhost:3000/stylesheets/style.css' rel='stylesheet' type='text/css' />
<link href='http://localhost:3000/stylesheets/syntax.css' rel='stylesheet' type='text/css' />

<meta content='width=device-width, initial-scale=1.0, user-scalable=no' name='viewport'>
<meta content='text/html; charset=utf-8' http-equiv='content-type' />

  <meta content='http://localhost:3000/posts/boost-log' property='og:url' />
  <meta content="概述编译配置  boost库 log模块是静态库形式存在, 程序链接时需要链接多个库boost_log_setup boost_log boost_thread boost_system;  编译选项还要包含-DBOOST_LOG_D..." property='og:description' />
  <meta content="article" property="og:type" />

<!-- - -->





  </head>
  <body class="lh-copy dark-gray pa0 f6 sans-serif bg-super-white">
    <header class="tc mt4">
      <a href="http://localhost:3000">
        <img src="http://localhost:3000/images/scribble.png" alt="Home" width="53" height="59">
      </a>
      <p>cuipf blog</p>
    </header>
    <div class="mw7 bg-white mt4 mb3 center br2-ns bt bb ba-ns b--light-gray">
      <nav class="bb b--light-gray pv4 tc" aria-label="Main">
        
          <a class="link blue hover-mid-gray mh2 pv1"
             href="http://localhost:3000/">
             Posts
           </a>
        
          <a class="link blue hover-mid-gray mh2 pv1"
             href="http://localhost:3000/about">
             About me
           </a>
        
      </nav>

      <main class="tl f6 relative pa4 pa5-ns overflow-hidden">
        
          <div class="mb4">
            <div class="fw600 light-silver mt1">24 Apr 2017</div>
            <h1 class="ttu f3 mt0 lh-title cb mb2">
              
              boost::log使用
            </h1>
            
          </div>
        
        <div class="markdown-body">
          <h1 id="概述">概述</h1>
<h2 id="编译配置">编译配置</h2>
<ol>
  <li>boost库 log模块是静态库形式存在, 程序链接时需要链接多个库boost_log_setup boost_log boost_thread boost_system;</li>
  <li>编译选项还要包含<code class="highlighter-rouge">-DBOOST_LOG_DYN_LINK</code>, 否则也会报错;</li>
  <li>包含boost相关文件, 编译速度就会巨慢, 可以使用gcc -H参数查看编译连接所有的文件, 就知道有多少了; 解决办法: 使用头文件预编译技术后稍好, 暂时没有找到更好的办法;</li>
</ol>

<h2 id="命名空间">命名空间</h2>
<p>为了代码书写方便, 以及更加整洁; 一般都会对命名空间定义一些别名, 如下:</p>

<div class="language-c++ highlighter-rouge"><pre class="highlight"><code><span class="k">namespace</span> <span class="n">logging</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">log</span><span class="p">;</span>
<span class="k">namespace</span> <span class="n">src</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">log</span><span class="o">::</span><span class="n">sources</span><span class="p">;</span>
<span class="k">namespace</span> <span class="n">sinks</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">log</span><span class="o">::</span><span class="n">sinks</span><span class="p">;</span>
<span class="k">namespace</span> <span class="n">keywords</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">log</span><span class="o">::</span><span class="n">keywords</span><span class="p">;</span>
<span class="k">namespace</span> <span class="n">attrs</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">log</span><span class="o">::</span><span class="n">attributes</span><span class="p">;</span>
<span class="k">namespace</span> <span class="n">expr</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">log</span><span class="o">::</span><span class="n">expressions</span><span class="p">;</span>
</code></pre>
</div>

<h1 id="使用">使用</h1>
<h2 id="基本使用">基本使用</h2>
<p>带日志等级过滤boost log的基本使用实例如下:</p>
<div class="language-c++ highlighter-rouge"><pre class="highlight"><code><span class="k">namespace</span> <span class="n">logging</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">log</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">Init</span><span class="p">()</span>
<span class="p">{</span>
	<span class="c1">//logging::core::get() returns a pointer to the core singleton
</span>	<span class="n">logging</span><span class="o">::</span><span class="n">core</span><span class="o">::</span><span class="n">get</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">set_filter</span><span class="p">(</span><span class="n">logging</span><span class="o">::</span><span class="n">trivial</span><span class="o">::</span><span class="n">severity</span> <span class="o">&gt;=</span> <span class="n">logging</span><span class="o">::</span><span class="n">trivial</span><span class="o">::</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">TestBoostLog</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">Init</span><span class="p">();</span>
	<span class="n">BOOST_LOG_TRIVIAL</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">"A trace severity message"</span><span class="p">;</span>
	<span class="n">BOOST_LOG_TRIVIAL</span><span class="p">(</span><span class="n">debug</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">"A debug severity message"</span><span class="p">;</span>
	<span class="n">BOOST_LOG_TRIVIAL</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">"An informational severity message"</span><span class="p">;</span>
	<span class="n">BOOST_LOG_TRIVIAL</span><span class="p">(</span><span class="n">warning</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">"A warning severity message"</span><span class="p">;</span>
	<span class="n">BOOST_LOG_TRIVIAL</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">"An error severity message"</span><span class="p">;</span>
	<span class="n">BOOST_LOG_TRIVIAL</span><span class="p">(</span><span class="n">fatal</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">"A fatal severity message"</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>输出:</p>
<div class="highlighter-rouge"><pre class="highlight"><code>[2017-04-14 14:33:03.427867] [0x00007ffff7fd99c0] [info]    An informational severity message
[2017-04-14 14:33:03.427909] [0x00007ffff7fd99c0] [warning] A warning severity message
[2017-04-14 14:33:03.427918] [0x00007ffff7fd99c0] [error]   An error severity message
[2017-04-14 14:33:03.427925] [0x00007ffff7fd99c0] [fatal]   A fatal severity message
</code></pre>
</div>
<p>输出信息包含:</p>
<ol>
  <li>时间戳;</li>
  <li>当前线程的ID;</li>
  <li>日志的等级;</li>
  <li>Message, 日志内容;</li>
</ol>

<p><strong>说明:</strong></p>
<ol>
  <li>Trivial 头文件可用于一般的控制台输出, 日志的默认等级也定义该头文件, 这也是boost log库默认的日志等级;</li>
</ol>

<div class="language-c++ highlighter-rouge"><pre class="highlight"><code><span class="c1">//! Trivial severity levels
</span><span class="k">enum</span> <span class="n">severity_level</span>
<span class="p">{</span>
    <span class="n">trace</span><span class="p">,</span>
    <span class="n">debug</span><span class="p">,</span>
    <span class="n">info</span><span class="p">,</span>
    <span class="n">warning</span><span class="p">,</span>
    <span class="n">error</span><span class="p">,</span>
    <span class="n">fatal</span>
<span class="p">};</span>
</code></pre>
</div>
<ol>
  <li>全局日志等级过滤设置使用<code class="highlighter-rouge">logging::core::get()-&gt;set_filter</code>;</li>
  <li>注意<code class="highlighter-rouge">set_filter</code>参数, 使用的是<a href="http://www.boost.org/doc/libs/1_63_0/libs/phoenix/doc/html/index.html">Boost.Phoenix</a>  lambda表达式; 表达式的左边参数描述一个等待被校验的属性, 表达式的右边是需要被校验的值;</li>
  <li><code class="highlighter-rouge">logging::core::get()</code> 返回是一个指针指向core单例的;</li>
</ol>

<h2 id="日志输出">日志输出</h2>
<p>上例日志直接输出在控制台, 服务端日志直接输出到控制台肯定不可取, boost log支持自定义输出, 通过构造Sinks注册到logging code实现;</p>

<p>注意: 上例子中, 没有初始化任何sink, 依然可以运行, 这是因为log库包含一个默认的sink, 此sink以固定的格式打印到屏幕上;</p>

<h3 id="文件输出">文件输出</h3>

<div class="language-c++ highlighter-rouge"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">Init</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">logging</span><span class="o">::</span><span class="n">add_file_log</span><span class="p">(</span>
		<span class="n">keywords</span><span class="o">::</span><span class="n">file_name</span> <span class="o">=</span> <span class="s">"sample_%N.log"</span><span class="p">,</span>
		<span class="n">keywords</span><span class="o">::</span><span class="n">rotation_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
		<span class="n">keywords</span><span class="o">::</span><span class="n">time_based_rotation</span> <span class="o">=</span> <span class="n">sinks</span><span class="o">::</span><span class="n">file</span><span class="o">::</span><span class="n">rotation_at_time_point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">keywords</span><span class="o">::</span><span class="n">format</span> <span class="o">=</span> <span class="s">"[%TimeStamp%]: %Message%"</span>           
		<span class="p">);</span>
	<span class="c1">//logging::core::get() returns a pointer to the core singleton
</span>	<span class="n">logging</span><span class="o">::</span><span class="n">core</span><span class="o">::</span><span class="n">get</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">set_filter</span><span class="p">(</span><span class="n">logging</span><span class="o">::</span><span class="n">trivial</span><span class="o">::</span><span class="n">severity</span> <span class="o">&gt;=</span> <span class="n">logging</span><span class="o">::</span><span class="n">trivial</span><span class="o">::</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
</div>
<p>说明:</p>
<ul>
  <li>我们可以使用<code class="highlighter-rouge">logging::add_file_log</code>初始化sink, 保存log record 到文件中;</li>
  <li>该函数可以设置一些自定义选项:
    <ol>
      <li>日志文件的命名方式;</li>
      <li>每1mb滚动一次log文件;</li>
      <li>根据时间来滚动log文件;</li>
      <li>log输出的格式;</li>
    </ol>
  </li>
  <li>可以通过该函数注册多个sink, 每一个sink都可以接受处理日志, 且之间相互独立;</li>
</ul>

<h3 id="多种输出方式">多种输出方式</h3>

<div class="language-c++ highlighter-rouge"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">Init</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">typedef</span> <span class="n">sinks</span><span class="o">::</span><span class="n">synchronous_sink</span><span class="o">&lt;</span> <span class="n">sinks</span><span class="o">::</span><span class="n">text_ostream_backend</span> <span class="o">&gt;</span> <span class="n">text_sink</span><span class="p">;</span>
    <span class="c1">//设置输出到文件complex.log中
</span>	<span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span> <span class="n">text_sink</span> <span class="o">&gt;</span> <span class="n">sink</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">text_sink</span><span class="o">&gt;</span><span class="p">();</span>
	<span class="n">sink</span><span class="o">-&gt;</span><span class="n">locked_backend</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">add_stream</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">ofstream</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"complex.log"</span><span class="p">));</span>

	<span class="c1">//同时输出到console上
</span>	<span class="n">sink</span><span class="o">-&gt;</span><span class="n">locked_backend</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">add_stream</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">.</span><span class="n">rdbuf</span><span class="p">()));</span>
	<span class="c1">//输出到console上与上面等价
</span>	<span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&gt;</span> <span class="n">stream_ptr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">std</span><span class="o">::</span><span class="n">clog</span><span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">null_deleter</span><span class="p">());</span>
	<span class="n">sink</span><span class="o">-&gt;</span><span class="n">locked_backend</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">add_stream</span><span class="p">(</span><span class="n">stream_ptr</span><span class="p">);</span>
	<span class="n">logging</span><span class="o">::</span><span class="n">core</span><span class="o">::</span><span class="n">get</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">add_sink</span><span class="p">(</span><span class="n">sink</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
</div>

<p>这种方式, 和方式1中效果完全一样; 这里简要介绍一下sink, 后续有详细的介绍;</p>
<ul>
  <li>sink 分为前端(frontend)和后端(backend)sink;</li>
  <li>frontend sink(上述代码中synchronous_sink类模板)负责sink的通用任务; 如: 线程同步模式, 过滤, 格式化等;</li>
  <li>后端(在上述代码中使用text_ostream_backend类)实现sink特定的事情，如写到一个文件。</li>
  <li>boost log库提供了许多可直接使用的frontend sinks and backend sinks。</li>
  <li>synchronous_sink 表明sink是线程安全的, 即backend sink不用担心线程安全问题;</li>
  <li>text_ostream_backend 类可以将格式化的log写入到各种stream中; 上面分别展现了输出到文件, 以及两种输出到console的方式;</li>
  <li>注册多个sink与注册一个sink但包含多个目标stream是有区别的; 对于前者sink之间相互独立; 后者效率较高;</li>
  <li>locked_backend成员函数是线程安全的; 函数返回是一个指向backend的智能指针; <strong>注意:</strong> 该智能指针存在期间, backend一直是锁住状态; 也就意味着其他线程想要把日志写到该backend sink上将会被阻塞, 直到backend sink被释放;</li>
</ul>

<p>boost log库提供了多个用于处理各种日志逻辑的backends sinks; 例如: 你可以将日志发送(by network)到syslog 服务器通过指定syslog backend; 你也可以设置Windows NT Event log backend来监控你应用的运行时间; 等等;</p>

<h2 id="日志创建与写入">日志创建与写入</h2>
<p>上面我们简单说了一下日志如何存储以及存储在哪里的问题; 接下来了解一下如何创建日志源以及如何写日志 ?</p>

<div class="language-c++ highlighter-rouge"><pre class="highlight"><code><span class="n">src</span><span class="o">::</span><span class="n">logger</span> <span class="n">lg</span><span class="p">;</span>
</code></pre>
</div>

<ol>
  <li>日志源sources不需要想sinks一样被注册, sources直接和log core直接交互;</li>
  <li>boost log 提供两个版本的logger, 线程安全版和非线程安全版;</li>
  <li>boost log库提供大量包含不同特征的loggers; 如日志等级以及对channel支持; 这些特征可以自由相互组合构成不同功能的logger;</li>
</ol>

<h3 id="全局logger对象">全局logger对象</h3>

<p>log库提供了一种声明全局loggers对象的方法:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>BOOST_LOG_INLINE_GLOBAL_LOGGER_DEFAULT(global_logger, src::logger_mt)
</code></pre>
</div>

<p>说明:</p>

<ol>
  <li>global_logger 用户自定义的logger; 后续可以使用该global_logger获取logger实例;
    <div class="highlighter-rouge"><pre class="highlight"><code>//获取全局唯一的logger实例
src::logger_mt&amp; lg = my_logger::get();
</code></pre>
    </div>
  </li>
  <li>logger_mt 线程安全logger;</li>
</ol>

<h3 id="写日志">写日志</h3>

<p>无论你使用的是哪一种logger(类成员变量模式还是全局模式, 线程安全或不安全), 都可以使用一下方式写日志:</p>
<div class="language-c++ highlighter-rouge"><pre class="highlight"><code><span class="c1">//声明全局logger 对象
</span><span class="n">BOOST_LOG_INLINE_GLOBAL_LOGGER_DEFAULT</span><span class="p">(</span><span class="n">global_logger</span><span class="p">,</span> <span class="n">src</span><span class="o">::</span><span class="n">logger_mt</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">PutLogRecords</span><span class="p">()</span>
<span class="p">{</span>
	<span class="c1">//获取logger实例
</span>	<span class="n">src</span><span class="o">::</span><span class="n">logger_mt</span><span class="o">&amp;</span> <span class="n">lg</span> <span class="o">=</span> <span class="n">global_logger</span><span class="o">::</span><span class="n">get</span><span class="p">();</span>
	<span class="n">BOOST_LOG</span><span class="p">(</span><span class="n">lg</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">"global macro write log records"</span><span class="p">;</span>
	<span class="c1">//log写入
</span>	<span class="n">logging</span><span class="o">::</span><span class="n">record</span> <span class="n">rec</span> <span class="o">=</span> <span class="n">lg</span><span class="p">.</span><span class="n">open_record</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rec</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">logging</span><span class="o">::</span><span class="n">record_ostream</span> <span class="n">strm</span><span class="p">(</span><span class="n">rec</span><span class="p">);</span>
		<span class="n">strm</span> <span class="o">&lt;&lt;</span> <span class="s">"global logger write"</span><span class="p">;</span>
		<span class="n">strm</span><span class="p">.</span><span class="n">flush</span><span class="p">();</span>
		<span class="n">lg</span><span class="p">.</span><span class="n">push_record</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">rec</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>
<p>输出:</p>
<div class="highlighter-rouge"><pre class="highlight"><code>[2017-04-19 15:38:01.191468] [0x00007ffff7fd8740] [info] global macro write log records
[2017-04-19 15:38:01.191551] [0x00007ffff7fd8740] [info] global logger write
</code></pre>
</div>
<p>说明:</p>
<ol>
  <li>鼓励使用BOOST_LOG宏进行日志写入;</li>
  <li>open_record调用可以用于判断record是否被创建以及至少被一个sinks处理;</li>
  <li>过滤也可以在这个阶段设置;</li>
</ol>

<h2 id="日志属性">日志属性</h2>
<ul>
  <li>每一个log record都有多个命名的属性, 这些属性代表着日志记录的条件: 在代码中的位置, 执行模块的名字, 当前时间, 或者是与你程序相关的任何数据和运行环境.</li>
  <li>每一个属性都会对应一个属性值, 可以供过滤, 格式化和sinks使用; boost log库中自带大量用户常用的属性.</li>
  <li>属性分为三种:　source-specific, thread-specific 和 global；　当log record形成, 与之相关这三种组成一个集合传递到sinks中;</li>
  <li>每一个属性需要一个独一无二的名字, 方便检索; 如果在不同的作用域存在同名属性, 覆盖次序: 源相关属性 &gt; 线程相关属性 &gt; 全局属性; 这样可以通过注册本地属性来覆盖全局和线程相关属性, 以减少线程干扰;</li>
</ul>

<h3 id="属性注册">属性注册</h3>
<h4 id="公用属性">公用属性</h4>
<p>一些属性是任何程序都会使用到的, 比如: 日志记录个数, 时间等等; 这些公用的属性可以通过下面的函数添加:</p>
<div class="language-c++ highlighter-rouge"><pre class="highlight"><code><span class="n">logging</span><span class="o">::</span><span class="n">add_common_attributes</span><span class="p">();</span>
</code></pre>
</div>
<p>通过该函数调用, 日志行ID, 时间戳, 进程ID, 线程ID都会被注册; 当然, 单线程模式下, 线程ID没有被注册.</p>

<p>**注意: **</p>

<ol>
  <li>程序启动默认, 没有注册任何属性, 可以在程序初始化时完成属性注册; 之前Trivial logging实例由于使用的默认sink, 所以包含日志等级等默认属性, 因此不需要初始化;</li>
  <li>一旦你使用过滤, 格式化, 以及非默认sink, 你就必须注册必要的属性.</li>
</ol>

<p>还有一些属性在logger构造时候会被自动注册, 例如: 日志的等级.</p>

<h4 id="更多属性">更多属性</h4>
<div class="language-c++ highlighter-rouge"><pre class="highlight"><code><span class="c1">//自定义log安全属性
</span><span class="kt">void</span> <span class="nf">logging_function</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">src</span><span class="o">::</span><span class="n">severity_logger</span><span class="o">&lt;</span> <span class="n">severity_level</span> <span class="o">&gt;</span> <span class="n">slg</span><span class="p">;</span>
	<span class="n">BOOST_LOG_SEV</span><span class="p">(</span><span class="n">slg</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">"A regular message"</span><span class="p">;</span>
	<span class="n">BOOST_LOG_SEV</span><span class="p">(</span><span class="n">slg</span><span class="p">,</span> <span class="n">warning</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">"Something bad is going on but I can handle it"</span><span class="p">;</span>
	<span class="n">BOOST_LOG_SEV</span><span class="p">(</span><span class="n">slg</span><span class="p">,</span> <span class="n">critical</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">"Everything crumbles, shoot me now!"</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//添加scope name 对每一个log record
</span><span class="kt">void</span> <span class="nf">named_scope_logging</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">BOOST_LOG_NAMED_SCOPE</span><span class="p">(</span><span class="s">"named_scope_logging"</span><span class="p">);</span>
	<span class="n">src</span><span class="o">::</span><span class="n">severity_logger</span><span class="o">&lt;</span> <span class="n">severity_level</span> <span class="o">&gt;</span> <span class="n">slg</span><span class="p">;</span>
	<span class="n">BOOST_LOG_SEV</span><span class="p">(</span><span class="n">slg</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">"Hello from the function named_scope_logging!"</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//添加自定义tag
</span><span class="kt">void</span> <span class="nf">tagged_logging</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">src</span><span class="o">::</span><span class="n">severity_logger</span><span class="o">&lt;</span> <span class="n">severity_level</span> <span class="o">&gt;</span> <span class="n">slg</span><span class="p">;</span>
	<span class="n">slg</span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">"Tag"</span><span class="p">,</span> <span class="n">attrs</span><span class="o">::</span><span class="n">constant</span><span class="o">&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&gt;</span><span class="p">(</span><span class="s">"My tag value"</span><span class="p">));</span>
	<span class="n">BOOST_LOG_SEV</span><span class="p">(</span><span class="n">slg</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">"Here goes the tagged record"</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>
<p>说明:</p>
<ol>
  <li>通过添加自定义tag属性, 可以用于后续的格式化以及过滤;</li>
  <li>添加scope name可以标记应用程序不同部分产生log;</li>
</ol>

<p>此外, 也可以使用boost log添加Timeline属性, 构成一个简单的profiling工具来检测性能, Timeline包含高精度的时间信息，可以用来判断哪一部分程序需要很多的执行时间。如下:</p>
<div class="language-c++ highlighter-rouge"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">timed_logging</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">BOOST_LOG_SCOPED_THREAD_ATTR</span><span class="p">(</span><span class="s">"Timeline"</span><span class="p">,</span> <span class="n">attrs</span><span class="o">::</span><span class="n">timer</span><span class="p">());</span>
	<span class="n">src</span><span class="o">::</span><span class="n">severity_logger</span><span class="o">&lt;</span> <span class="n">severity_level</span> <span class="o">&gt;</span> <span class="n">slg</span><span class="p">;</span>
	<span class="n">BOOST_LOG_SEV</span><span class="p">(</span><span class="n">slg</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">"Starting to time nested functions"</span><span class="p">;</span>
	<span class="n">logging_function</span><span class="p">();</span>
	<span class="n">BOOST_LOG_SEV</span><span class="p">(</span><span class="n">slg</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">"Stopping to time nested functions"</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>
<p>输出:</p>
<div class="highlighter-rouge"><pre class="highlight"><code>00000003: &lt;normal&gt;	() [00:00:00.000005] Starting to time nested functions
00000004: &lt;normal&gt;	() [00:00:00.000176] A regular message
00000005: &lt;warning&gt;	() [00:00:00.000230] Something bad is going on but I can handle it
00000006: &lt;critical&gt;() [00:00:00.000267] Everything crumbles, shoot me now!
00000007: &lt;normal&gt;	() [00:00:00.000301] Stopping to time nested functions
</code></pre>
</div>
<h3 id="属性占位符">属性占位符</h3>
<p>属性占位符主要在接下来的部分会用到,  每一个属性指定一个关键词, 这个关键词在日志过滤和格式化中会被用到;</p>
<div class="language-c++ highlighter-rouge"><pre class="highlight"><code><span class="c1">//placeholder
</span><span class="n">BOOST_LOG_ATTRIBUTE_KEYWORD</span><span class="p">(</span><span class="n">line_id</span><span class="p">,</span> <span class="s">"LineID"</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span>
<span class="n">BOOST_LOG_ATTRIBUTE_KEYWORD</span><span class="p">(</span><span class="n">severity</span><span class="p">,</span> <span class="s">"Severity"</span><span class="p">,</span> <span class="n">severity_level</span><span class="p">)</span>
<span class="n">BOOST_LOG_ATTRIBUTE_KEYWORD</span><span class="p">(</span><span class="n">tag_attr</span><span class="p">,</span> <span class="s">"Tag"</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">)</span>
<span class="n">BOOST_LOG_ATTRIBUTE_KEYWORD</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="s">"Scope"</span><span class="p">,</span> <span class="n">attrs</span><span class="o">::</span><span class="n">named_scope</span><span class="o">::</span><span class="n">value_type</span><span class="p">)</span>
<span class="n">BOOST_LOG_ATTRIBUTE_KEYWORD</span><span class="p">(</span><span class="n">timeline</span><span class="p">,</span> <span class="s">"Timeline"</span><span class="p">,</span> <span class="n">attrs</span><span class="o">::</span><span class="n">timer</span><span class="o">::</span><span class="n">value_type</span><span class="p">)</span>
</code></pre>
</div>
<p>说明:</p>
<ol>
  <li>宏的第一个参数就是keyword, 第二个参数是属性名, 第三个参数属性值类型;</li>
</ol>

<h2 id="日志格式化">日志格式化</h2>
<p>如果之前的实例(不包含使用默认输出的例子), 没有添加格式化, 输出的日志信息就只有Message信息;</p>

<p>设置方法:</p>
<ol>
  <li><code class="highlighter-rouge">add_file_log</code>中通过<code class="highlighter-rouge">keyword::format</code>设置;</li>
  <li>如果手动设置了sink, 可以通过sink的set_formatter来设置;</li>
</ol>

<h3 id="lambda-风格格式化">lambda 风格格式化</h3>
<div class="language-c++ highlighter-rouge"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">init</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">logging</span><span class="o">::</span><span class="n">add_file_log</span>
    <span class="p">(</span>
        <span class="n">keywords</span><span class="o">::</span><span class="n">file_name</span> <span class="o">=</span> <span class="s">"sample_%N.log"</span><span class="p">,</span>
        <span class="c1">// 日志输出格式
</span>        <span class="c1">// 1: &lt;normal&gt; A normal severity message
</span>        <span class="n">keywords</span><span class="o">::</span><span class="n">format</span> <span class="o">=</span>
        <span class="p">(</span>
            <span class="n">expr</span><span class="o">::</span><span class="n">stream</span>
                <span class="o">&lt;&lt;</span> <span class="n">expr</span><span class="o">::</span><span class="n">attr</span><span class="o">&lt;</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">&gt;</span><span class="p">(</span><span class="s">"LineID"</span><span class="p">)</span>
                <span class="o">&lt;&lt;</span> <span class="s">": &lt;"</span> <span class="o">&lt;&lt;</span> <span class="n">logging</span><span class="o">::</span><span class="n">trivial</span><span class="o">::</span><span class="n">severity</span>
                <span class="o">&lt;&lt;</span> <span class="s">"&gt; "</span> <span class="o">&lt;&lt;</span> <span class="n">expr</span><span class="o">::</span><span class="n">smessage</span>
        <span class="p">)</span>
    <span class="p">);</span>
<span class="p">}</span>
</code></pre>
</div>
<p>如上, 这里格式化使用的都是占位符, 我们可以在过滤器和格式化工具中使用同样的占位符; attr占位符和severity占位符类似, 它们表示属性值; 不同的是severity占位符表示名称为”Severity”和类型为
trivial::severity_level的属性，attr可以表示任何属性。
我们也可以使用下面方式代替severity占位符:</p>
<div class="language-c++ highlighter-rouge"><pre class="highlight"><code><span class="n">expr</span><span class="o">::</span><span class="n">attr</span><span class="o">&lt;</span> <span class="n">logging</span><span class="o">::</span><span class="n">trivial</span><span class="o">::</span><span class="n">severity_level</span> <span class="o">&gt;</span><span class="p">(</span><span class="s">"Severity"</span><span class="p">)</span>
</code></pre>
</div>

<p>也可以提供一些其他属性的初始化如日期, 时间, LineID等等;</p>
<div class="language-c++ highlighter-rouge"><pre class="highlight"><code><span class="n">sink</span><span class="o">-&gt;</span><span class="n">set_formatter</span>
		<span class="p">(</span>
		<span class="n">expr</span><span class="o">::</span><span class="n">stream</span>
		<span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">hex</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">setw</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">setfill</span><span class="p">(</span><span class="sc">'0'</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">line_id</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">dec</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">setfill</span><span class="p">(</span><span class="sc">' '</span><span class="p">)</span>
		<span class="o">&lt;&lt;</span> <span class="s">": &lt;"</span> <span class="o">&lt;&lt;</span> <span class="n">severity</span> <span class="o">&lt;&lt;</span> <span class="s">"&gt;</span><span class="se">\t</span><span class="s">"</span>
		<span class="o">&lt;&lt;</span> <span class="s">"("</span> <span class="o">&lt;&lt;</span> <span class="n">scope</span> <span class="o">&lt;&lt;</span> <span class="s">") "</span>
		<span class="o">&lt;&lt;</span> <span class="n">expr</span><span class="o">::</span><span class="n">if_</span><span class="p">(</span><span class="n">expr</span><span class="o">::</span><span class="n">has_attr</span><span class="p">(</span><span class="n">tag_attr</span><span class="p">))</span>
		<span class="p">[</span>
			<span class="n">expr</span><span class="o">::</span><span class="n">stream</span> <span class="o">&lt;&lt;</span> <span class="s">"["</span> <span class="o">&lt;&lt;</span> <span class="n">tag_attr</span> <span class="o">&lt;&lt;</span> <span class="s">"] "</span>
		<span class="p">]</span>
	    <span class="o">&lt;&lt;</span> <span class="n">expr</span><span class="o">::</span><span class="n">if_</span><span class="p">(</span><span class="n">expr</span><span class="o">::</span><span class="n">has_attr</span><span class="p">(</span><span class="n">timeline</span><span class="p">))</span>
		<span class="p">[</span>
			<span class="n">expr</span><span class="o">::</span><span class="n">stream</span> <span class="o">&lt;&lt;</span> <span class="s">"["</span> <span class="o">&lt;&lt;</span> <span class="n">timeline</span> <span class="o">&lt;&lt;</span> <span class="s">"] "</span>
		<span class="p">]</span>
	    <span class="o">&lt;&lt;</span> <span class="n">expr</span><span class="o">::</span><span class="n">smessage</span>
		<span class="p">);</span>
</code></pre>
</div>

<h3 id="boostformat-风格格式化">Boost.Format 风格格式化</h3>
<div class="language-c++ highlighter-rouge"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">init</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">typedef</span> <span class="n">sinks</span><span class="o">::</span><span class="n">synchronous_sink</span><span class="o">&lt;</span> <span class="n">sinks</span><span class="o">::</span><span class="n">text_ostream_backend</span> <span class="o">&gt;</span> <span class="n">text_sink</span><span class="p">;</span>
    <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span> <span class="n">text_sink</span> <span class="o">&gt;</span> <span class="n">sink</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span> <span class="n">text_sink</span> <span class="o">&gt;</span><span class="p">();</span>
    <span class="n">sink</span><span class="o">-&gt;</span><span class="n">locked_backend</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">add_stream</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">ofstream</span> <span class="o">&gt;</span><span class="p">(</span><span class="s">"sample.log"</span><span class="p">));</span>
    <span class="c1">// 日志输出格式
</span>    <span class="c1">// 1: &lt;normal&gt; A normal severity message
</span>    <span class="c1">// 2: &lt;error&gt; An error severity message
</span>    <span class="n">sink</span><span class="o">-&gt;</span><span class="n">set_formatter</span>
    <span class="p">(</span>
        <span class="n">expr</span><span class="o">::</span><span class="n">format</span><span class="p">(</span><span class="s">"%1%: &lt;%2%&gt; %3%"</span><span class="p">)</span>
            <span class="o">%</span> <span class="n">expr</span><span class="o">::</span><span class="n">attr</span><span class="o">&lt;</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">&gt;</span><span class="p">(</span><span class="s">"LineID"</span><span class="p">)</span>
            <span class="o">%</span> <span class="n">logging</span><span class="o">::</span><span class="n">trivial</span><span class="o">::</span><span class="n">severity</span>
            <span class="o">%</span> <span class="n">expr</span><span class="o">::</span><span class="n">smessage</span>
    <span class="p">);</span>

    <span class="n">logging</span><span class="o">::</span><span class="n">core</span><span class="o">::</span><span class="n">get</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">add_sink</span><span class="p">(</span><span class="n">sink</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
</div>
<p>boost log格式化也支持<a href="http://www.boost.org/doc/libs/1_63_0/libs/log/doc/html/log/tutorial/formatters.html">Boost.Format</a>格式, 具体的语法不在这里赘述;</p>

<h3 id="专门的格式化">专门的格式化</h3>
<p>boost log库提供了专门的初始化为有些类型属性, 如日期, 时间以及命名作用域; 例如: 格式化Date和time为<a href="http://www.boost.org/doc/libs/1_64_0/doc/html/date_time.html">Boost.DateTime</a>格式.</p>
<div class="language-c++ highlighter-rouge"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">init</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">logging</span><span class="o">::</span><span class="n">add_file_log</span>
    <span class="p">(</span>
        <span class="n">keywords</span><span class="o">::</span><span class="n">file_name</span> <span class="o">=</span> <span class="s">"sample_%N.log"</span><span class="p">,</span>
        <span class="c1">// YYYY-MM-DD HH:MI:SS: &lt;normal&gt; A normal severity message
</span>        <span class="n">keywords</span><span class="o">::</span><span class="n">format</span> <span class="o">=</span>
        <span class="p">(</span>
            <span class="n">expr</span><span class="o">::</span><span class="n">stream</span>
                <span class="o">&lt;&lt;</span> <span class="n">expr</span><span class="o">::</span><span class="n">format_date_time</span><span class="o">&lt;</span> <span class="n">boost</span><span class="o">::</span><span class="n">posix_time</span><span class="o">::</span><span class="n">ptime</span> <span class="o">&gt;</span><span class="p">(</span><span class="s">"TimeStamp"</span><span class="p">,</span> <span class="s">"%Y-%m-%d %H:%M:%S"</span><span class="p">)</span>
                <span class="o">&lt;&lt;</span> <span class="s">": &lt;"</span> <span class="o">&lt;&lt;</span> <span class="n">logging</span><span class="o">::</span><span class="n">trivial</span><span class="o">::</span><span class="n">severity</span>
                <span class="o">&lt;&lt;</span> <span class="s">"&gt; "</span> <span class="o">&lt;&lt;</span> <span class="n">expr</span><span class="o">::</span><span class="n">smessage</span>
        <span class="p">)</span>
    <span class="p">);</span>
<span class="p">}</span>
</code></pre>
</div>
<p>这种对日期时间的格式化也可以与上面Boost.Format风格一起使用.</p>

<h3 id="字符串风格格式化">字符串风格格式化</h3>

<p>有些情况下, 我们可以使用字符串模板格式化日志, 字符串中使用<code class="highlighter-rouge">%%</code>来标示占位符, 如: <code class="highlighter-rouge">%Message%</code>占位符会被日志记录message来代替;</p>
<div class="language-c++ highlighter-rouge"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">init</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">logging</span><span class="o">::</span><span class="n">add_file_log</span>
    <span class="p">(</span>
        <span class="n">keywords</span><span class="o">::</span><span class="n">file_name</span> <span class="o">=</span> <span class="s">"sample_%N.log"</span><span class="p">,</span>
        <span class="n">keywords</span><span class="o">::</span><span class="n">format</span> <span class="o">=</span> <span class="s">"[%TimeStamp%]: %Message%"</span>
    <span class="p">);</span>
<span class="p">}</span>
</code></pre>
</div>
<p>注: sink的成员函数<code class="highlighter-rouge">set_formatter</code>不支持该风格格式化(字符串风格);</p>

<h3 id="自定义格式化函数">自定义格式化函数</h3>
<p>上面几种格式化方式, 我们都是通过参数传递给具体的格式化函数; 实际上, 我们也可以定义我们自己格式化函数, 然后通过函数对象方式传递给log库格式化函数!</p>

<div class="language-c++ highlighter-rouge"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">MyFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">::</span><span class="n">record_view</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">rec</span><span class="p">,</span> <span class="n">logging</span><span class="o">::</span><span class="n">formatting_ostream</span><span class="o">&amp;</span> <span class="n">strm</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">strm</span> <span class="o">&lt;&lt;</span> <span class="n">logging</span><span class="o">::</span><span class="n">extract</span><span class="o">&lt;</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">&gt;</span><span class="p">(</span><span class="s">"LineID"</span><span class="p">,</span> <span class="n">rec</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">": "</span><span class="p">;</span>
    <span class="n">strm</span> <span class="o">&lt;&lt;</span> <span class="s">"&lt;"</span> <span class="o">&lt;&lt;</span> <span class="n">rec</span><span class="p">[</span><span class="n">logging</span><span class="o">::</span><span class="n">trivial</span><span class="o">::</span><span class="n">severity</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">"&gt; "</span><span class="p">;</span>
    <span class="n">strm</span> <span class="o">&lt;&lt;</span> <span class="n">rec</span><span class="p">[</span><span class="n">expr</span><span class="o">::</span><span class="n">smessage</span><span class="p">];</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">init</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">typedef</span> <span class="n">sinks</span><span class="o">::</span><span class="n">synchronous_sink</span><span class="o">&lt;</span> <span class="n">sinks</span><span class="o">::</span><span class="n">text_ostream_backend</span> <span class="o">&gt;</span> <span class="n">text_sink</span><span class="p">;</span>
    <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span> <span class="n">text_sink</span> <span class="o">&gt;</span> <span class="n">sink</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span> <span class="n">text_sink</span> <span class="o">&gt;</span><span class="p">();</span>
    <span class="n">sink</span><span class="o">-&gt;</span><span class="n">locked_backend</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">add_stream</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">ofstream</span> <span class="o">&gt;</span><span class="p">(</span><span class="s">"sample.log"</span><span class="p">));</span>
    <span class="n">sink</span><span class="o">-&gt;</span><span class="n">set_formatter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MyFormatter</span><span class="p">);</span>
    <span class="n">logging</span><span class="o">::</span><span class="n">core</span><span class="o">::</span><span class="n">get</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">add_sink</span><span class="p">(</span><span class="n">sink</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
</div>
<p>说明:</p>
<ul>
  <li>logging::record_view 和log::record相似; 区别: record_view是不可修改且实现浅拷贝; 日志格式化和过滤所有操作都是在record_view层面的, 并不会直接影响到log record, 这些record可能被其他sinks使用在其他线程中;</li>
</ul>

<h2 id="日志过滤">日志过滤</h2>
<p>上面很多次都提到日志过滤, 在概述中简单使用过日志等级过滤; 较复杂的日志过滤设置如下:</p>
<div class="language-c++ highlighter-rouge"><pre class="highlight"><code><span class="n">BOOST_LOG_ATTRIBUTE_KEYWORD</span><span class="p">(</span><span class="n">line_id</span><span class="p">,</span> <span class="s">"LineID"</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span>
<span class="n">BOOST_LOG_ATTRIBUTE_KEYWORD</span><span class="p">(</span><span class="n">severity</span><span class="p">,</span> <span class="s">"Severity"</span><span class="p">,</span> <span class="n">severity_level</span><span class="p">)</span>
<span class="n">BOOST_LOG_ATTRIBUTE_KEYWORD</span><span class="p">(</span><span class="n">tag_attr</span><span class="p">,</span> <span class="s">"Tag"</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">)</span>

<span class="kt">void</span> <span class="n">init</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">logging</span><span class="o">::</span><span class="n">formatter</span> <span class="n">fmt</span> <span class="o">=</span> <span class="n">expr</span><span class="o">::</span><span class="n">stream</span>
        <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">setw</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">setfill</span><span class="p">(</span><span class="sc">'0'</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">line_id</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">setfill</span><span class="p">(</span><span class="sc">' '</span><span class="p">)</span>
        <span class="o">&lt;&lt;</span> <span class="s">": &lt;"</span> <span class="o">&lt;&lt;</span> <span class="n">severity</span> <span class="o">&lt;&lt;</span> <span class="s">"&gt;</span><span class="se">\t</span><span class="s">"</span>
        <span class="o">&lt;&lt;</span> <span class="n">expr</span><span class="o">::</span><span class="n">if_</span><span class="p">(</span><span class="n">expr</span><span class="o">::</span><span class="n">has_attr</span><span class="p">(</span><span class="n">tag_attr</span><span class="p">))</span>
           <span class="p">[</span>
               <span class="n">expr</span><span class="o">::</span><span class="n">stream</span> <span class="o">&lt;&lt;</span> <span class="s">"["</span> <span class="o">&lt;&lt;</span> <span class="n">tag_attr</span> <span class="o">&lt;&lt;</span> <span class="s">"] "</span>
           <span class="p">]</span>
        <span class="o">&lt;&lt;</span> <span class="n">expr</span><span class="o">::</span><span class="n">smessage</span><span class="p">;</span>

    <span class="c1">// Initialize sinks
</span>    <span class="k">typedef</span> <span class="n">sinks</span><span class="o">::</span><span class="n">synchronous_sink</span><span class="o">&lt;</span> <span class="n">sinks</span><span class="o">::</span><span class="n">text_ostream_backend</span> <span class="o">&gt;</span> <span class="n">text_sink</span><span class="p">;</span>
    <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span> <span class="n">text_sink</span> <span class="o">&gt;</span> <span class="n">sink</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span> <span class="n">text_sink</span> <span class="o">&gt;</span><span class="p">();</span>
    <span class="n">sink</span><span class="o">-&gt;</span><span class="n">locked_backend</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">add_stream</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">ofstream</span> <span class="o">&gt;</span><span class="p">(</span><span class="s">"full.log"</span><span class="p">));</span>
    <span class="n">sink</span><span class="o">-&gt;</span><span class="n">set_formatter</span><span class="p">(</span><span class="n">fmt</span><span class="p">);</span>

    <span class="n">logging</span><span class="o">::</span><span class="n">core</span><span class="o">::</span><span class="n">get</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">add_sink</span><span class="p">(</span><span class="n">sink</span><span class="p">);</span>
    <span class="n">sink</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span> <span class="n">text_sink</span> <span class="o">&gt;</span><span class="p">();</span>

    <span class="n">sink</span><span class="o">-&gt;</span><span class="n">locked_backend</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">add_stream</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">ofstream</span> <span class="o">&gt;</span><span class="p">(</span><span class="s">"important.log"</span><span class="p">));</span>
    <span class="n">sink</span><span class="o">-&gt;</span><span class="n">set_formatter</span><span class="p">(</span><span class="n">fmt</span><span class="p">);</span>
    <span class="n">sink</span><span class="o">-&gt;</span><span class="n">set_filter</span><span class="p">(</span><span class="n">severity</span> <span class="o">&gt;=</span> <span class="n">warning</span> <span class="o">||</span> <span class="p">(</span><span class="n">expr</span><span class="o">::</span><span class="n">has_attr</span><span class="p">(</span><span class="n">tag_attr</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">tag_attr</span> <span class="o">==</span> <span class="s">"IMPORTANT_MESSAGE"</span><span class="p">));</span>
    <span class="n">logging</span><span class="o">::</span><span class="n">core</span><span class="o">::</span><span class="n">get</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">add_sink</span><span class="p">(</span><span class="n">sink</span><span class="p">);</span>
    <span class="n">logging</span><span class="o">::</span><span class="n">add_common_attributes</span><span class="p">();</span>
<span class="p">}</span>
</code></pre>
</div>
<p>实例中输出到日志文件”important.log”的sink添加过滤; 通过调用函数<code class="highlighter-rouge">set_filter</code>实现, 函数接收参数依然是Boost.Phoenix风格;</p>

<p>当然你也可以像自定格式化函数一样, 自定义过滤函数:</p>
<div class="language-c++ highlighter-rouge"><pre class="highlight"><code><span class="kt">bool</span> <span class="nf">MyFilter</span><span class="p">(</span><span class="n">logging</span><span class="o">::</span><span class="n">value_ref</span><span class="o">&lt;</span> <span class="n">severity_level</span><span class="p">,</span> <span class="n">tag</span><span class="o">::</span><span class="n">severity</span> <span class="o">&gt;</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">level</span><span class="p">,</span>
<span class="n">logging</span><span class="o">::</span><span class="n">value_ref</span><span class="o">&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="n">tag</span><span class="o">::</span><span class="n">tag_attr</span> <span class="o">&gt;</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">level</span> <span class="o">&gt;=</span> <span class="n">warning</span> <span class="o">||</span> <span class="n">tag</span> <span class="o">==</span> <span class="s">"IMPORTANT_MESSAGE"</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">init</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">namespace</span> <span class="n">phoenix</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">phoenix</span><span class="p">;</span>
    <span class="n">sink</span><span class="o">-&gt;</span><span class="n">set_filter</span><span class="p">(</span><span class="n">phoenix</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_filter</span><span class="p">,</span> <span class="n">severity</span><span class="p">.</span><span class="n">or_none</span><span class="p">(),</span> <span class="n">tag_attr</span><span class="p">.</span><span class="n">or_none</span><span class="p">()));.</span>
<span class="p">}</span>
</code></pre>
</div>

        </div>
        <p class="mt4">
<!---Til next time,<br>--->
  cuipf
<!---  <span class="silver">at 00:00</span> --->
</p>
<img src="http://localhost:3000/images/scribble3.png" alt="scribble" />

      </main>
      <section class="fixed-l mw7 center w-100 top-50 tc pb4 nt4">
  
  
</section>
    </div>
    <footer class="mw7 center tc pt3 pb4 silver">
<!---      Built with Jekyll using <a href="http://github.com/muan/scribble" class="link silver hover-blue pv1">Scribble</a>. --->
      <img src="http://localhost:3000/images/scribble2.png" alt="scribble" class="mt4 db center" />
    </footer>
  </body>
</html>
